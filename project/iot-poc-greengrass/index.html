<!DOCTYPE html><html lang="en-us" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.1.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Anders E. Nielsen" />

  
  
  
    
  
  <meta name="description" content="In this tutorial, we build an IoT edge with Greengrass." />

  
  <link rel="alternate" hreflang="en-us" href="../../project/iot-poc-greengrass/" />

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  

  
  
  
    <meta name="theme-color" content="#023e8a" />
  

  
  
    
    <script src="../../js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather%7CRoboto+Mono&display=swap">
      
    
  

  
  
  
  
  
  <link rel="stylesheet" href="../../css/wowchemy.f7eaf83122b08ab266aaa8a2d08cb1e8.css" />

  



  

  

  




  
  
  

  

  
    <link rel="manifest" href="../../index.webmanifest" />
  

  <link rel="icon" type="image/png" href="../../media/icon_hu0b500a15011e1e483635372eebf6e1df_24681_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="../../media/icon_hu0b500a15011e1e483635372eebf6e1df_24681_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="../../project/iot-poc-greengrass/" />

  
  
  
  
  
  
  
  
    
  
  
  <meta property="twitter:card" content="summary_large_image" />
  
  <meta property="og:site_name" content="anders e" />
  <meta property="og:url" content="/project/iot-poc-greengrass/" />
  <meta property="og:title" content="Build an Edge with Greengrass | anders e" />
  <meta property="og:description" content="In this tutorial, we build an IoT edge with Greengrass." /><meta property="og:image" content="/project/iot-poc-greengrass/featured.jpg" />
    <meta property="twitter:image" content="/project/iot-poc-greengrass/featured.jpg" /><meta property="og:locale" content="en-us" />
  
    
      <meta
        property="article:published_time"
        content="2020-06-16T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2020-06-16T00:00:00&#43;00:00">
  

  


    









<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/project/iot-poc-greengrass/"
  },
  "headline": "Build an Edge with Greengrass",
  
  "image": [
    "/project/iot-poc-greengrass/featured.jpg"
  ],
  
  "datePublished": "2020-06-16T00:00:00Z",
  "dateModified": "2020-06-16T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Anders E. Nielsen"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "anders e",
    "logo": {
      "@type": "ImageObject",
      "url": "/media/icon_hu0b500a15011e1e483635372eebf6e1df_24681_192x192_fill_lanczos_center_3.png"
    }
  },
  "description": "In this tutorial, we build an IoT edge with Greengrass."
}
</script>

  

  

  

  





  <title>Build an Edge with Greengrass | anders e</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="13c7e33606a0fefbc51b242ab9d381df" >

  
  
  
  
  
  
  
  
  <script src="../../js/wowchemy-init.min.a8a181ea67095ef9fbb0e99ffbf585a0.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="Search...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="../../">anders e</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="../../">anders e</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../post/"><span>Blog</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="../../about/"><span>About</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true" aria-label="Display preferences">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    <article class="article article-project">

  




















  
  
    
  


<div class="article-container pt-3">
  <h1>Build an Edge with Greengrass</h1>

  

  


<div class="article-metadata">

  
  

  
  <span class="article-date">
    
    
      
    
    2020-06-16
  </span>
  

  

  

  
  
  
  
  
  

  
  

</div>

  




<div class="btn-links mb-3">
  
  








  


















  
  
  
    
  
  
  
  
  
    
  
  <a class="btn btn-outline-primary btn-page-header" href="https://github.com/AnHosu" target="_blank" rel="noopener">
    <i class="fab fa-github mr-1"></i>
    Go to project repo
  </a>

  
  
  
    
  
  
  
  
  
    
    
      
    
  
  <a class="btn btn-outline-primary btn-page-header" href="../../project/iot-poc/" >
    <i class="fas fa-network-wired mr-1"></i>
    iIoT Meta Post
  </a>


</div>


</div>


<div class="article-header article-container featured-image-wrapper mt-4 mb-4" style="max-width: 720px; max-height: 476px;">
  <div style="position: relative">
    <img src="../../project/iot-poc-greengrass/featured_hu7f0023a47d1c7b17188e19def7bab572_232772_720x0_resize_q75_lanczos.jpg" alt="" class="featured-image">
    
  </div>
</div>



  <div class="article-container">

    <div class="article-style">
      <p>It is time to create an edge; to take advantage of the compute that is available right where the data is gathered. Even if we use the AWS IoT services, there are several ways and plenty of 3<sup>rd</sup> party software we could apply for device management and creating an edge. The AWS offering is Greengrass, a piece of software running on our gateway device and an accompanying cloud service. In this demonstration, we introduce key concepts in the context of an IoT edge using Greengrass.<br>
In this demonstration we will</p>
<ul>
<li>Install AWS Greengrass Core on our Raspberry Pi</li>
<li>Register the Pi as a Core Device in the AWS Greengrass console</li>
<li>Connect a our sensor as a thing through Greengrass, sending data to AWS IoT</li>
<li>Define a calculation in the cloud and deploy it onto the edge using a Lambda function in Greengrass
<br></li>
</ul>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_group_architecture.png" alt="iot setup">
  This is the architecture we are building in this demonstration.
</div>
<h1 id="motivation">Motivation</h1>
<p>When we walk through the demonstration, it might seem like a lot of hassle and extra steps to go through before data is flowing and we reach what is essentially the same state as in previous demonstrations, where we just <a href="../../project/iot-poc-publishing/">published</a> readings and <a href="../../project/iot-poc-pubsub/">subscribed</a> directly in the script that also queried our sensor. Indeed, Greengrass is not intended for use with a single sensor. Imagine, however, that we are managing hundreds of sensors on a factory floor. The factory might be far away, or the gowning procedure might prohibit frequent visits, but even if our desk is right next to the manufacturing line, we still do not want to physically go there each time we deploy changes to sensor data streams, restart devices, define new signal processing, or update software. Greengrass allows us to define functionality in the cloud and deploy it to our device with a click.<br><br>
Another important aspect of our IoT application to consider is cost. It is tempting to just send all raw data to storage in the cloud. Cloud storage is indeed inexpensive, but it is not free. What is worse, however, is the cost of compute. Cloud compute offers unprecedented flexibility, but it is expensive, so we generally want to use it to handle loads with varying intensity or low predictability, e.g. for hosting the application that uses data from the IoT setup. As an example of a case where we might quickly incur a large and unnecessary bill, imagine a set of vibration sensors. Vibration sensors are useful for predictive maintenance applications, since the patterns in vibrations from components like bearings and motors might be good predictors for the health of the component. An industrial grade vibration sensor might be able to sample acceleration thousands of times per second. If we were to store the data from just a few vibration sensors, we would quickly fill up enough storage to accomodate years worth of data from other sources like factory floor temperature and humidity. Furthermore, since it is not the acceleration itself but characteristics of the vibrations we are interested in, each time we use the data we would have to do signal processing and recalculate features. If we do that using cloud compute, we will work up quite a bill. The financially and environmentally responsible way to implement vibration sensors is to do the signal processing as close to the sampling point as possible and then only store the calculated features. We still want the flexibility of developing in the cloud and deploying to a remote device, however. While we will not work with signal processing in this demonstration, we will create an example of data transformation and deploy it from the cloud to the Raspberry Pi using Greengrass.<br><br>
Conceptually, the setup for this demonstration is a bit different from that of the three previous demonstrations. The hardware is exactly the same but, in previous demonstrations, our Raspberry Pi acted the part of a microcontroller and essentially did not do a lot of work. In this demonstration, we will make use of the compute available on the Raspberry Pi, install Greengrass, and use it to manage the sensor. To demonstrate the concept of edge calculations, we will create a transformation that corrects for the fact that the temperature sensor is right next the CPU of our Pi.<br><br>
Let us get started!</p>
<div align="center">
	<img width=500 src="../iot-poc/images/hardware_setup.jpg" alt="iot setup">
    Notice that the BME680 air quality sensor is right next to the CPU of the Pi, which interferes with the temperature readings. The edge calculation example of this demonstration will attempt to correct the temperature reading from the BME680 by substracting an amount based on the current CPU temperature.
</div>
<h1 id="install-and-configure-greengrass">Install and Configure Greengrass</h1>
<p>The AWS Greengrass service consists of two main elements. The first, Greengrass Core, is a piece of software that is installed on our gateway device, in our case, the Raspberry Pi. Its main functionality is being an MQTT broker like IoT Core, but acting locally. However, it has other available functionality such as the ability to manage and run Lambda functions. We loosely refer to the gateway device and Greengrass Core as an &lsquo;Edge&rsquo;. The software is configured to communicate with Greengrass in AWS IoT, which constitutes the other element. We loosely refer to AWS IoT as the &lsquo;Cloud&rsquo; part.<br><br>
The process of installing Greengrass Core depends a lot on our device and its operating system, but the docs contain a <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/module2.html" title="install Greengrass" target="_blank" rel="noopener">general guide</a>. I used apt to install Greengrass on the Pi. When following this guide, you will</p>
<ul>
<li><a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/gg-config.html" target="_blank" rel="noopener">Register the Greengrass Core</a> in AWS IoT. Remember to download the package with certificates onto your device</li>
<li><a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/what-is-gg.html#gg-core-download-tab" title="ggc software" target="_blank" rel="noopener">Download</a> the packaged software for your specific device and operating system</li>
<li>Set up the user group (ggc_group) and user (ggc_user) that Greengrass Core will assume on your device</li>
<li><a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/gg-device-start.html" target="_blank" rel="noopener">Unpack software</a> and install certificates</li>
<li>Download and install the root CA certificate</li>
</ul>
<p>If it is not already available on the device, we might want to install the Java 8 runtime</p>
<pre><code class="language-bash">sudo apt install openjdk-8-jdk
</code></pre>
<p>For this demonstration we will use Python 3.7 for the functions we deploy into Greengrass Core. Therefore we also need to make sure that Python 3.7 is available to Greengrass core on the device.<br><br>
In order for Greengrass to use these runtimes, the names of the binaries must be very specific. Python must be named <code>Python3.7</code> and the Java runtime must be named <code>Java8</code>. If the versions installed are correct, but the binaries are not named the way Greengrass expects, e.g. Java 8 is just called <code>Java</code>, we can either rename them or create symlinks:</p>
<pre><code class="language-bash"># These are examples. Modify to your particular setup
sudo ln -s /usr/bin/python3 /usr/bin/python3.7
sudo ln -s /usr/bin/java /usr/bin/java8
</code></pre>
<p>Once we have done all these steps, we might want to check that we have all the dependencies we need by running the Greengrass dependency checker:</p>
<pre><code class="language-bash">mkdir greengrass-dependency-checker-GGCv1.10.x
cd greengrass-dependency-checker-GGCv1.10.x
wget https://github.com/aws-samples/aws-greengrass-samples/raw/master/greengrass-dependency-checker-GGCv1.10.x.zip
unzip greengrass-dependency-checker-GGCv1.10.x.zip
cd greengrass-dependency-checker-GGCv1.10.x
sudo ./check_ggc_dependencies | more
</code></pre>
<p>The dependency checker will also provide hints if it cannot locate Python or Java. Make sure these are available. We do not need the other optional dependencies.<br>
When all is set up and configured, we can start Greengrass by running</p>
<pre><code class="language-bash">cd /greengrass/ggc/core/
sudo ./greengrassd start
</code></pre>
<p>Greengrass Core will need to be running on our device in order to establish a connection between Core and the cloud. You can walk through the <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/module3-I.html" target="_blank" rel="noopener">AWS hello world cases</a> to familiarise yourself with Greengrass. We are going to do many of the same things in this demonstration but in a slightly different order and using our hardware setup instead of simulated devices.</p>
<h1 id="build-a-greengrass-group">Build a Greengrass Group</h1>
<p>During the setup, we created a Greengrass Group. The Group will eventually consist of one core device (in our case the Pi) and a variety of entities associated with the core. Our eventual goal is to have data sent from a thing that is associated with the core to the cloud. To reach that ambition we need to configure the thing, i.e. our sensor, a Lambda function that will move the data to the cloud, and subscriptions. We will go through each of these components in turn, starting with the thing.<br></p>
<h2 id="associate-a-thing-with-a-greengrass-group">Associate a Thing with a Greengrass Group</h2>
<p>To associate our thing, the sensor, with the core, we follow the <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/device-group.html" title="register a thing in Greengrass" target="_blank" rel="noopener">guidelines</a>, and go to AWS IoT &gt; Greengrass &gt; Groups, choose the group we just created, go to Devices, and click &ldquo;Add Device&rdquo;.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_device_add.png" alt="iot setup">
</div>
<p>The creation procedure is similar to the procedure for any other Thing registered in AWS IoT. Indeed, after registering the device, we will be able to find it under the AWS IoT &gt; Manage tab and we are even able to associate existing devices with a core. I actually reused the device from the <a href="../../project/iot-poc-publishing/#registering-the-sensor-in-iot-core">publishing</a> demonstration for this demo.<br>
Note that before the device is fully associated with the core, the change needs to be deployed. We will go through how to do this after configuring a few more things.</p>
<h2 id="connect-a-device-to-greengrass-core">Connect a Device to Greengrass Core</h2>
<p>In this section, we will setup up a script that connects to the core with the eventual goal of publishing readings from the sensor to a topic. The messages will never reach the cloud, however. Instead, the messages are published into the core device on a topic that only lives within the the Greengrass group. The logic is something along the lines of</p>
<pre><code>setup sensor
connect to Greengrass core
while true
	get sensor values
	publish to local topic
</code></pre>
<p>This logic is very similar to what we did in the case of simple <a href="../../project/iot-poc-publishing/">publishing</a>, and indeed the two cases are very similar. The main difference is that we will set up and configure a client that connects to the local MQTT broker in Greengrass Core rather than the cloud based broker in IoT Core.<br><br>
To connect a device/thing to Greengrass core, we use the same MQTT client as always and, as usual, we will need a variety of resources to establish the right connection.</p>
<pre><code class="language-python">from AWSIoTPythonSDK.MQTTLib import AWSIoTMQTTClient

myAWSIoTMQTTClient = AWSIoTMQTTClient(clientId)
myAWSIoTMQTTClient.configureCredentials(groupCA, privateKeyPath, certificatePath)
myAWSIoTMQTTClient.configureEndpoint(coreHost, corePort)
</code></pre>
<p>Let us discuss each of these resources in turn.</p>
<ul>
<li><code>clientId</code> could be anything allowed by the policy we created for our thing in the previous step. To keep down complexity, using the device ID is a prudent idea.</li>
<li><code>privateKeyPath</code> is the complete path to the key associated with the certificate created earlier for our thing.</li>
<li><code>certificatePath</code> is the complete path to the certificate for our thing that we created earlier.</li>
<li><code>groupCA</code> is the certificate authority for our Greengrass group and is used to authenticate that our thing is indeed connected to the intended Greengrass core when sending and receiving messages. In a moment we will walk through how to obtain this certificate. Note that this is <em>not</em> the root certificate authority used when communicating with AWS IoT Core.</li>
<li><code>coreHost</code> is the server running the Greengrass Core, i.e. our core device</li>
<li><code>corePort</code> is the port on which our thing will communicate with the core using the MQTT protocol. The default setting when generating a new Greengrass Core is 8883, but we could <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/gg-core.html" target="_blank" rel="noopener">configure</a> this, if we wanted to.</li>
</ul>
<p>The three first elements are realtively straight forward; we know these from when we created the thing and its certificate in the first place. The three remaining resources, however, require a bit of additional work. The group certificate is managed by AWS and by default it is rotated every 7 days. This requires a little bit of effort on our part when connecting things to the core, but is worth it for the free added security. Since the the Greengrass Core is connected to AWS, AWS also knows the host and port, and so while we are querying AWS for the group certificate, we can also retrieve these two pieces of information. This process of retrieving connection information is called core discovery and is the only time our thing will connect to the cloud. Once connected to the core, all communication will be with it.<br></p>
<h3 id="core-discovery">Core Discovery</h3>
<p>To set up the discovery process, we need a special dicovery client that is also included in the AWS IoT SDK</p>
<pre><code class="language-python">from AWSIoTPythonSDK.core.greengrass.discovery.providers import DiscoveryInfoProvider

discoveryInfoProvider = DiscoveryInfoProvider()
discoveryInfoProvider.configureEndpoint(host)
discoveryInfoProvider.configureCredentials(rootCAPath, certificatePath, privateKeyPath)
discoveryInfoProvider.configureTimeout(10)
</code></pre>
<p>The discovery client is set up using the usual materials; the AWS IoT custom endpoint for our account, the AWS root certificate authority, the private key, and certificate for our thing. We also tell the client to wait a maximum of 10 seconds before timing out a connection attempt.<br>
The client can be used to send a discovery request to AWS and fetch connection information for the core. It works like this:</p>
<pre><code class="language-python"># Returns list of AWSIoTPythonSDK.core.greengrass.discovery.models.DiscoveryInfo objects
discoveryInfo = discoveryInfoProvider.discover(thingName)
</code></pre>
<p>We provide the thing name of the thing for which we are looking up connection information. In most of our applications this is probably the same as our client ID, but in this case it <em>has</em> to be the name of our thing as registered in AWS.<br>
If the request is successful, <code>discoveryInfo</code> will hold information about Greengrass groups that the device belongs to (a device can belong to several groups, but each group has exactly one core). Of interest to us are the certificate authorities and the connection information, the lists of which can be accessed as such:</p>
<pre><code class="language-python"># Returns list of AWSIoTPythonSDK.core.greengrass.discovery.models.CoreConnectivtyInfo objects
caList = discoveryInfo.getAllCas()
# Returns list of tuples (CA content, group ID)
coreList = discoveryInfo.getAllCores()
</code></pre>
<p>These are lists with each entry representing a core. If our device only belongs to a single Greengrass core, this list will only have one entry. We can get the certificate authority for the first available core like this</p>
<pre><code class="language-python">groupId, ca = caList[0]
</code></pre>
<p>Each core might have several connection options so we might like to keep them in a list to loop over later</p>
<pre><code class="language-python">coreInfo = coreList[0]
# Get a list of tuples (host, port)
coreConnectivityInfoList = coreInfo.connectivityInfoList
</code></pre>
<p>Now we have everything we need to have out thing automatically discover and connect to the Greengrass core:</p>
<pre><code class="language-python">from AWSIoTPythonSDK.core.greengrass.discovery.providers import DiscoveryInfoProvider
from AWSIoTPythonSDK.core.protocol.connection.cores import ProgressiveBackOffCore
from AWSIoTPythonSDK.MQTTLib import AWSIoTMQTTClient
# Configure client for gg core discovery
discoveryInfoProvider = DiscoveryInfoProvider()
discoveryInfoProvider.configureEndpoint(host)
discoveryInfoProvider.configureCredentials(rootCAPath, certificatePath, privateKeyPath)
discoveryInfoProvider.configureTimeout(10)
# Discover gg cores for the thing
discoveryInfo = discoveryInfoProvider.discover(thingName)
# Get connection info
caList = discoveryInfo.getAllCas()
coreList = discoveryInfo.getAllCores()
# Get info for the first core
groupId, ca = caList[0]
coreInfo = coreList[0]
coreConnectivityInfoList = coreInfo.connectivityInfoList

# Since the MQTT client expects a certificate file we have to
#  put the group certificate authority into a file and save
#  the path
groupCA = GROUP_CA_PATH + groupId + &quot;_CA_&quot; + str(uuid.uuid4()) + &quot;.crt&quot;
if not os.path.exists(GROUP_CA_PATH):
    os.makedirs(GROUP_CA_PATH)
groupCAFile = open(groupCA, &quot;w&quot;)
groupCAFile.write(ca)
groupCAFile.close()
    
# Initialise the MQTT client
myAWSIoTMQTTClient = AWSIoTMQTTClient(clientId)
myAWSIoTMQTTClient.configureCredentials(groupCA, privateKeyPath, certificatePath)

# Loop over and try connection with each set of host name and port
connected = False
for connectionInfo in coreConnectivityInfoList:
    coreHost = connectionInfo.host
    corePort = connectionInfo.port
    myAWSIoTMQTTClient.configureEndpoint(coreHost, corePort)
    try:
        myAWSIoTMQTTClient.connect()
        connected = True
        break
    except BaseException as e:
        pass
</code></pre>
<p>This is the most condensed code needed to implement discovery, but in production we will want to add much more logging, error handling, retries for discoveries, and other frills. See the section below on Greengrass in production for a further discussion on how to improve the thing script for a real world scenario.</p>
<h3 id="publish-inside-the-greengrass-group">Publish inside the Greengrass Group</h3>
<p>Now that our thing is connected to the core in its Greengrass group we can start publishing data to a local topic. From the point of view of our thing, this works just like publishing to a topic on AWS IoT. Using the client we configured:</p>
<pre><code class="language-python">myAWSIoTMQTTClient.publish(topic, messageJson, 1)
</code></pre>
<p>With this, we have everything needed to run our thing running. The <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_thing.py" title="example script" target="_blank" rel="noopener">example script</a> for this section summarises everything we have done so far but contains a bit more detail. It is based off of the <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/basicDiscovery.py" title="AWS IoT SDK basic discovery example" target="_blank" rel="noopener">example</a> included with the AWS IoT SDK and was adapted to be used with our hardware setup. Note that the functionality in this script is running on the same Pi as the Greengrass software. In a real production setting, however, the two are likely to be seperate physical devices.<br><br>
Once again, it is worth noting that if we have not deployed after associating the thing with the core, then our core device does not yet know that it is allowed to associate with the thing and the discovery process will fail. Specifically, we will get a <code>DiscoveryDataNotFoundException</code>. It happens to me all the time, but all we need to do is deploy the change. We will do so shortly.<br><br>
Even assuming that the Greengrass core is running and the thing script is publishing values, not much is happening yet. If we go to the AWS IoT test test client in the console and subscribe to the topic that the thing is publishing to, there should be no values flowing in, as nothing is being sent there. In order for us to see data flowing into the cloud, we have to grab the data in Greengrass Core and pass it on to a new topic that is published to the cloud.<br>
The way this is done with Greengrass is by defining a Lambda function in AWS and deploying onto the core.</p>
<h2 id="write-lambda-functions-for-greengrass">Write Lambda Functions for Greengrass</h2>
<p>Lambda functions are a huge subject on their own and, for the purposes of this demonstration, we will assume at least some fammiliarity with the concept. We will still walk through each step needed to writing a Lambda for the edge, but if you are new to AWS Lambda, you might want to read the <a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started.html" title="AWS Lambda getting started" target="_blank" rel="noopener">getting started guide</a> to get a feel for the terminology. Lambda is a pretty cool service, and chances are that you will find it useful for plenty of other applications.<br></p>
<h3 id="lambda-code">Lambda Code</h3>
<p>The first Lambda we will write is very simple. It should take an incoming MQTT message, parse the message, and republish it on a new topic to AWS IoT. So something along the lines of</p>
<pre><code>get incoming message
extract body of message
republish body to new topic
</code></pre>
<p>Very linear, if we assume that the code is only run when there is an incoming message. This is exactly the power of Lambda. We can make a MQTT message, such as the ones we publish from the sensor, trigger a Lambda function. In the next section, we will go through how to set up the trigger. For now, just assume that the code we write is triggered each time there is a message.<br>
A Lambda always has a function handler that contains the details of whatever triggered the function:</p>
<pre><code class="language-python">def function_handler(event, context):
    # event holds the message body
    # context holds the incoming topic etc.
</code></pre>
<p>We can name the function whatever we want, just as long as we remember that name and give it the input objects <code>event</code> and <code>context</code>.<br>
The <code>event</code> object holds the body of the MQTT message that triggered the Lambda. This is essentially the json we want to pass on to a new topic.<br>
The <code>context</code> object holds all sorts of information on what triggered the Lambda, including the topic of the message. We do not really need any of this information now, so we can just ignore it.<br><br>
In order to republish to AWS IoT, we are, as usual, going to need an MQTT client. Remember though that we went through all sorts of trouble to connect the core to AWS IoT and that the core is itself an MQTT broker, so there is no need to set up a new client and connection. Instead, we use one of the clients included in the <a href="https://github.com/aws/aws-greengrass-core-sdk-python" title="Greengrass Python SDK" target="_blank" rel="noopener">Greengrass SDK</a>:</p>
<pre><code class="language-python">import greengrasssdk

client = greengrasssdk.client('iot-data')
</code></pre>
<p>We do not have to install the SDK on our device, but we will need to include it in our Lambda. There are multiple client types included in the SDK, and since we are doing IoT stuff, we need the <code>iot-data</code> client.<br><br>
Now we just need to decide on the topic to publish to. This needs to be a topic allowed in the policy for the core. With that, we have everything needed for the Lambda function:</p>
<pre><code class="language-python">import greengrasssdk

REPUB_TOPIC = 'republish/reading'

client = greengrasssdk.client('iot-data')

def function_handler(event, context):
    client.publish(topic=REPUB_TOPIC, payload=event)
    return
</code></pre>
<p>This is all we need to republish. The full example with a few extra frills, such as adding the incoming topic to the output body, is <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_simple_lambda.py" title="Simple Lambda example for Greengrass" target="_blank" rel="noopener">here</a>. Let us now look at creating the actual Lambda.</p>
<h3 id="create-a-lambda-function">Create a Lambda Function</h3>
<p>To create a Lambda function, we navigate to the AWS Lambda console. Under &lsquo;Functions&rsquo; we click &lsquo;Create Function&rsquo;.<br>
In the wizard, we choose &lsquo;Author from scratch&rsquo;, give our function a name, and choose our Python runtime. I named mine &lsquo;repub_temp&rsquo; and have been using Python 3.7 for the example. Then we click &lsquo;Create Function&rsquo;. This might take a moment.<br></p>
<div align="center">
	<img width=500 src="../iot-poc/images/lambda_create.png" alt="iot setup">
</div>
<p>The next thing we need to do is to prepare our code for the Lambda function. So leave the console for a little while and locate the Python script we just created. Now download the <a href="https://github.com/aws/aws-greengrass-core-sdk-python/tree/master/greengrasssdk" target="_blank" rel="noopener">Greengrass SDK</a> folder. We only need the &lsquo;greengrasssdk&rsquo; folder, not the examples, docs, etc. Now package the Greengrass SDK and the Python script into a .zip.<br></p>
<div align="center">
	<img width=500 src="../iot-poc/images/lambda_package.png" alt="iot setup">
</div>
<p>Now jump back to the console and scroll down to the &lsquo;Function Code&rsquo; window. In the &lsquo;Code entry type&rsquo; dropdown, select the &lsquo;Upload a .zip file&rsquo; option and upload the .zip file we just created. Also make sure to change the Handler to <code>&lt;function file&gt;.&lt;our handler function&gt;</code>, in the case of this example, it is <code>greengrass_simple_lambda.function_handler</code>. Click &lsquo;Save&rsquo; to save the changes.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/lambda_function_code.png" alt="iot setup">
</div>
<p>Now scroll up and, under the &lsquo;Actions&rsquo; dropdown, select &lsquo;Publish new version&rsquo;. We can optionally provide a version description.<br></p>
<div align="center">
	<img height="100" src="../iot-poc/images/lambda_actions.png" alt="iot setup">
</div>
<p>Now we go to &lsquo;Actions&rsquo; again and select &lsquo;Create alias&rsquo;. We give the alias a name and point it to the version we just created. Greengrass does not support pointers to the <code>$latest</code> version, so make sure to select a specific version.<br></p>
<div align="center">
	<img width=500 src="../iot-poc/images/lambda_alias.png" alt="iot setup">
</div>
<p>Now that our Lambda has been fully defined, we need to associate it with the Greengrass core.</p>
<h3 id="attach-a-lambda-to-greengrass">Attach a Lambda to Greengrass</h3>
<p>Navigate to the Greengrass console. Go to &lsquo;Groups&rsquo; and select the Greengrass group. Then go to the &lsquo;Lambdas&rsquo; menu and click &lsquo;Add Lambda&rsquo;.<br></p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_lambda_add.png" alt="iot setup">
</div>
<p>Choose &lsquo;Use an existing Lambda function&rsquo;. Select the Lambda function we just created and click &lsquo;Next&rsquo;. Select the alias we just created and click &lsquo;Finish&rsquo;.<br>
That is it for the Lambda. Now the final piece of the puzzle is ensuring that data flows from the sensor to the Lambda function and then from the Lambda function to the cloud. This is done with subscriptions.</p>
<h2 id="configure-subscriptions-in-greengrass">Configure Subscriptions in Greengrass</h2>
<p>Subscriptions are the way to configure where what data goes inside the Greengrass group. They specify the pubsub verticies between the things and Lambdas of the group and offer filtering capabilities.<br><br>
To set up a subscription, go to the Greengrass console. Go to &lsquo;Groups&rsquo; and select our Greengrass group. Then go to the &lsquo;Subscriptions&rsquo; menu and click &lsquo;Add Subscription&rsquo;.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_subscription_add.png" alt="iot setup">
</div>
<p>When setting up at subscription we are asked to specify the source and the target. The source and target could be many things, including a specific device/thing, a Lambda function, the cloud, or a Shadow. Subscriptions are one-way, so a two-way communication between two entities within the group would require two subscriptions.<br>
For this demonstration specifically, we want to set up a subscription from our thing which generates and publishes data locally to the Lambda function we created. The thing can be found under the &lsquo;Devices&rsquo; tab and the function under the &lsquo;Lambdas&rsquo; tab.<br>
Clicking &lsquo;Next&rsquo; the first time will spawn a topic filter box. This is an optional filter we can specify to make data flows even more dynamic. I have given an example here, but it is not neccessary for the purposes of this demonstration. Click &lsquo;Next&rsquo; again and &lsquo;Finish&rsquo; to create the subscription.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_subscription_tolambda.png" alt="iot setup">
</div>
<p>We need one more subscription, namely the one telling Greengrass that we are publishing data from the Lambda function to the Cloud. We set up another subscription; this time setting the Lambda function as the source and &lsquo;IoT Cloud&rsquo; as the target. Again we can specify an optional filter.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_subscription_fromlambda.png" alt="iot setup">
</div>
<p>Now all the pieces are in place. We are ready to deploy.</p>
<h2 id="deploy-a-greengrass-group">Deploy a Greengrass Group</h2>
<p>Right now, nothing is running on our gateway device except for the Greengrass daemon. Unless we have deployed along the way, none of the device configurations, Lambda function, or subscriptions have made their way onto the core.<br>
Before deploying, we should make sure that the Greengrass Daemon is actually running on our gateway device. From a shell on our device</p>
<pre><code class="language-bash">ps aux | grep -E 'greengrass.*daemon'
</code></pre>
<p>If the output from this command includes a root entry for <code>/greengrass/ggc/packages/1.10.1/bin/daemon</code>, then the daemon is running. If the daemon is not running, recall that we can start it using:</p>
<pre><code class="language-bash">cd /greengrass/ggc/core/
sudo ./greengrassd start
</code></pre>
<p>Now we are ready to deploy. Fortunately it is very simple to deploy everything we have specified. From our group in the Greengrass console, we are always within sight of the &lsquo;Action&rsquo; dropdown menu which has a &lsquo;Deploy&rsquo; option that we will now click on and utilise. If all goes well the status of our device will go from &lsquo;Is pending&rsquo; to &lsquo;In progress&rsquo; to &lsquo;Successfully completed&rsquo;.</p>
<div align="center">
	<img width=150 src="../iot-poc/images/greengrass_deploy.png" alt="iot setup">
</div>
<h2 id="put-everything-together">Put Everything Together</h2>
<p>To get the example for this section to work, we need to do a few things in the correct order.</p>
<ol>
<li>Ensure that the device representing our sensor is associated with the core</li>
<li>Ensure that the <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_simple_lambda.py" target="_blank" rel="noopener">Lambda function</a> is defined and associated with the core</li>
<li>Ensure that there is a subscription from the device to the Lambda function and another subscription from the Lambda function to the cloud</li>
<li>Ensure that the Greengrass daemon is running</li>
<li>Deploy everything</li>
<li>Run the discovery and publishing <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_thing.py" target="_blank" rel="noopener">script</a> for the sensor device</li>
</ol>
<p>We can run the script like this:</p>
<pre><code class="language-bash">python3.7 greengrass_thing.py -e &lt;AWS IoT custom endpoint&gt; -r &lt;root CA&gt; -c &lt;thing certificate&gt; -k &lt;private key&gt; -id &lt;client ID&gt; -t &lt;local topic&gt;
</code></pre>
<p>And let us quickly look at whether it is working by going to the IoT test client. If we have done everythin correctly, we should not see any data published on the local topic from the sensor device. Rather, we should see data from the topic <code>republish/reading</code> topic that we defined in the Lambda script. Let us see.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_test.png" alt="iot setup">
	<br>
</div>
<p>It is indeed working!<br><br>
Congratulations! You now know how to work with Greengrass and you have all the neccessary components to create your own Greengrass groups and create powerful IoTs with edges. However, if you are interested and want to know why we went through so much trouble to connect our device through Greengrass, I have another small example demonstrating the concept and power of &lsquo;calculations on the edge&rsquo;.</p>
<h1 id="do-calculations-on-the-edge">Do Calculations on the Edge</h1>
<p>Compared to <a href="../../project/iot-poc-publishing/">simple publishing</a>, having a device publish its data through Greengrass might seem like a large unnecessary hassle. Indeed, sometimes it is, but as soon as our IoT starts to grow beyond a few devices, there will be headaches that are much more simple to solve when Greengrass and, in particular, Lambda is there.<br>
In this example, we will demonstrate the utility of the setup through a simple example. I placed the BME680 air quality sensor quite close to the CPU of my Pi, meaning that the temperature of the CPU will interfere with what I really want to measure; the temperature of the air. If we were to obtain the temperature of the CPU, we might be able to calcualte a compensated temperature that is more representative of the air temperature. A quick disclaimer before we begin: there are a plethora of ways to avoid or compensate for this particular problem, including extending the sensor away from the Pi or including the compensation logic in the feeder script, but for the sake of this example assume that we have no flexibility in terms of the hardware and are aiming for a high degree of flexibility and maintainability in the software we create.<br><br>
Specifically, we will create a Lambda function that performs the compensation for us. We will go for something simple like</p>
<pre><code>compensated_temperature = 2 * temperature_reading - average_cpu_temperature
</code></pre>
<p>This is a very rough estimate, but it will get us going with a minimum viable solution.<br>
Since we are working with a Raspberry Pi, we can easily get the CPU temperature by reading the file <code>/sys/class/thermal/thermal_zone0/temp</code> like this:</p>
<pre><code class="language-python">def get_cpu_temperature():
    f = open(&quot;/sys/class/thermal/thermal_zone0/temp&quot;)
    raw_temp = f.read()
    f.close()
    return float(raw_temp)/1000.0
</code></pre>
<p>CPU temperatures can be somewhat jittery, so let us read the temperature in an interval an get the average before we calculate the compensated temperature</p>
<pre><code class="language-python">for n in range(8):
    cpu_temps.append(get_cpu_temperature())
    time.sleep(1)
avg_cpu_temp = sum(cpu_temps)/float(len(cpu_temps))
# Compensated temperature
comp_temp = 2*input_temperature - avg_cpu_temp
</code></pre>
<p>That is really all there is to it, and this is all we need to add to the previous example. The <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_sys_lambda.py" target="_blank" rel="noopener">full Lambda function example</a> has a few extra frills such as error handing and logging. The next step is to define this Lambda function and associate it with the Greengrass group. We could create a new Lambda function, but I opted to update the Lambda function we created in the previous section. To do so, open the function in the Lambda console, insert the <a href="https://github.com/AnHosu/iot_poc/blob/master/example_scripts/greengrass_sys_lambda.py" target="_blank" rel="noopener">code</a> and publish a new version. Then, from the &lsquo;Version&rsquo; dropdown menu, select the alias we created earlier.</p>
<div align="center">
	<img height=170 src="../iot-poc/images/lambda_new_alias.png" alt="iot setup">
</div>
<p>Scroll down a bit, find the &lsquo;Alias configuration&rsquo;, and point the alias to the version of the Lambda we just created. Click &lsquo;Save&rsquo; to save changes.<br><br>
Before we deploy, the Lambda will need some additional configuring. By default, any Lambda will timeout after 3 seconds, but ours will be running for at least 8 seconds to get an average CPU temperature. Furthermore, Lambda functions running in Greengrass to not have access to local resources under <code>/sys</code>. We will need to change these defaults.<br>
Go to the Greengrass console and select the group. Under the Lambda menu, click the three dots in the upper right of the Lambda function, we just modified and select &lsquo;Edit configuration&rsquo;.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_lambda_configure.png" alt="iot setup">
</div>
<p>Set the timeout to 10 seconds and enable access to <code>/sys</code>.</p>
<div align="center">
	<img width=500 src="../iot-poc/images/greengrass_lambda_configurations.png" alt="iot setup">
</div>
<p>All that is left is to deploy the Greengrass group from the Greengrass console. The resulting output to the cloud should look exactly like before. This time around though, the temperature readings should look a bit more realistic.<br><br>
Congratulations! You are now doing calculations on the edge. It might not feel like much, but consider how we might have gone about solving the problem in other ways.<br>
We could have published CPU temperature readings to the cloud and done the calcualtions using Lambda functions, SQL queries, or EC2 compute in the cloud. The cost of the additional storage and the cloud compute would make such a solution several times more expensive that what we just did.<br>
We could have put the calculations directly in the feeder script. While this would cost slightly less than our solution, it increases the operational burden. Sensors and microcontrollers are generally less accessible, especially in a manufacturing context. With our solution, we can manage the calculations in the cloud from the comfort of our chair or even home. If we wanted to start recording the temperature in Kelvins, all we would have to do is add the calculation to our Lambda function and deploy the changes.<br><br>
This was a very simple example of edge calculations managed from the cloud. Greengrass is, however, capable of handling much more complex setups than what we just built. Specifically, it is even possible to deploy machine learning models that are trained in the cloud onto the edge. These advanced features of Greengrass are the subject of the <a href="../../project/iot-poc-greengrass_ml/" title="Advanced features of Greengrass demo">next demonstration</a>.</p>
<h1 id="in-production">In Production</h1>
<p>This section is not part of the demonstration as such. It is but a short discussion of some of the considerations we have to take when bringing Greengrass to production in a manufacturing environment and how to improve upon the examples to make them production ready. Considerations from <a href="../../project/iot-poc-publishing/#in-production">previous demonstrations</a> still apply.</p>
<h2 id="default-vs-custom-core-config">Default vs Custom Core Config</h2>
<p>Note that in the demonstration we just went for the default options when setting up the Greengrass core. This creates a new ploicy for the certificate attached to the core. The policy is extremely permissive and, while it works great for demonstration purposes, it might not be what we want in a production setting.<br>
The great thing about Greengrass is that we can define aggregations and handle the diversity of incoming data at the edge and then only publish to a set of neatly organised topics to the cloud. This means that we can manage a diverse set of topics and devices at the edge but still have a very restrictive policy for communication with the cloud.</p>
<h2 id="handle-certificate-authority-rotation">Handle Certificate Authority Rotation</h2>
<p>Per default, the CA for the local MQTT server run by Greengrass is rotated every 7 days. We can adjust this to be more or less frequent, but if the Greengrass core remains connected to the cloud it will eventually be rotated. This is a layer of free added security that we do not have to manage, but it requires a bit of extra development considerations for our devices.<br>
In particular, our devices must be able to handle a situation where the CA obtained in the initial discovery process is no longer valid. Depending on our production architecture, we might have to call the discovery process again.<br>
More details are available in the <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/device-auth.html" target="_blank" rel="noopener">documentation</a> in the section &lsquo;Certificate Rotation on the Local MQTT Server&rsquo;.</p>
<h2 id="manage-the-greengrass-lifecycle">Manage the Greengrass Lifecycle</h2>
<p>Chances are that the device running Greengrass core will need to reboot at some point. Rather than starting the Greengrass daemon manually, we want it to start automatically on reboot. The <a href="https://docs.aws.amazon.com/greengrass/latest/developerguide/install-ggc.html#ggc-package-manager-systemd" target="_blank" rel="noopener">documentation</a> has information of how to do so but, for a Raspberry Pi, it is fairly straightforward to do using systemd.<br><br>
Verify that the Greengrass configuration option to use systemd is set to yes. The config file can be found on the Greengrass device at <code>/greengrass/config/config.json</code>. Ensure that <code>&quot;useSystemd&quot; : &quot;yes&quot;</code>, otherwise change it.<br><br>
Make service a service file at <code>/etc/systemd/system/greengrass.service</code></p>
<pre><code>[Unit]
Description=Greengrass Daemon

[Service]
Type=forking
PIDFile=/var/run/greengrassd.pid
Restart=on-failure
ExecStart=/greengrass/ggc/core/greengrassd start
ExecReload=/greengrass/ggc/core/greengrassd restart
ExecStop=/greengrass/ggc/core/greengrassd stop

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Make the service exeutable</p>
<pre><code class="language-bash">sudo chmod u+rwx /etc/systemd/system/greengrass.service
</code></pre>
<p>Add service to systemd</p>
<pre><code class="language-bash">systemctl enable greengrass.service
</code></pre>
<p>Test the service by rebooting the device and confirming that the Greengrass daemon is running. We can check whether the daemon is running with</p>
<pre><code class="language-bash">ps aux | grep -E 'greengrass.*daemon'
</code></pre>
<h2 id="connection-retries-and-progressive-backoff-logic">Connection Retries and Progressive Backoff Logic</h2>
<p>Imagine the following situation. We have a couple of hundred sensors that connect to one or a few Greengrass core devices, and all run off of the same power supply. At one point, the power supply is switched off, maybe it is maintenance maybe it is an error, but after a while power returns and our sensors and their controllers reboot. We set up the controllers such that they will automatically try to reconnect with the core. This is fine, but suddenly the core is getting hundreds of connection requests within a few seconds, so the controllers are receiving errors. Now, obviously there is nothing wrong with the core devices; they are just getting too many requests, so we will want the controllers to retry the connection before giving up. However, we do not want to have them all retry at the same time lest we repeat the story again.<br>
The idea behind progressive backoff logic is to keep retrying but waiting progressively longer for each retry as well as throwing a bit of randomness into the wait time. One type of backoff logic, exponential backoff, waits exponentially longer before each retry. Here is a bit of Python style pseudocode showing the basics of it</p>
<pre><code class="language-python">import time

retries = 0
wait_time = 2
while retries &lt; max_retries:
    try:
        connect()
        break
    except connectionFailedException:
        time.sleep(wait_time)
        wait_time += wait_time*1.5
        wait_time += random_number
        retries += 1
</code></pre>
<p><a href="https://docs.aws.amazon.com/general/latest/gr/api-retries.html" title="AWS Docs on retries" target="_blank" rel="noopener">Each AWS SDK implements</a> some sort of backoff logic and so does the AWS IoT SDK, so we do not have to do it ourselves. To increase clarity, I did not include the retry logic in the examples for this demonstration, but it is fairly straightforward to get started</p>
<pre><code class="language-python">from AWSIoTPythonSDK.core.protocol.connection.cores import ProgressiveBackOffCore

backOffCore = ProgressiveBackOffCore()
retries = 0
while retries &lt; max_retries:
    try:
        connect()
        break
    except connectionFailedException:
        backOffCore.backOff()
        retries += 1
</code></pre>
<p>The SDK also ships with an <a href="https://github.com/aws/aws-iot-device-sdk-python/blob/master/samples/greengrass/basicDiscovery.py" target="_blank" rel="noopener">example</a> very similiar to what we did in the previous sections and also implements this backoff method.</p>

    </div>

    






<div class="article-tags">
  
  <a class="badge badge-light" href="../../tag/iot/">IoT</a>
  
  <a class="badge badge-light" href="../../tag/data/">Data</a>
  
  <a class="badge badge-light" href="../../tag/data-engineering/">Data Engineering</a>
  
</div>













  
  



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="../../"><img class="avatar mr-3 avatar-circle" src="../../author/anders-e.-nielsen/avatar_huaf22d72e35256be9d48177f1f21d9377_326351_270x270_fill_q75_lanczos_center.jpg" alt="Anders E. Nielsen"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="../../">Anders E. Nielsen</a></h5>
      <h6 class="card-subtitle">Data Professional &amp; Research Scientist</h6>
      <p class="card-text">I apply modern data technology to solve real-world problems. My interests include statistics, machine learning, computational biology, and IoT.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
    <li>
      <a href="mailto:andellegaard@gmail.com" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://www.linkedin.com/in/anders-ellegaard-nielsen-6a0857125/" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/AnHosu" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>
















  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="../../project/iot-poc/">Industrial IoT with AWS and Python</a></li>
      
      <li><a href="../../project/iot-poc-greengrass-ml/">Machine Learning at the Edge and other Advanced Features of Greengrass</a></li>
      
      <li><a href="../../project/iot-poc-publishing/">Publishing Industrial Data with AWS IoT</a></li>
      
      <li><a href="../../project/iot-poc-pubsub/">Publishing and Subscribing with AWS IoT</a></li>
      
      <li><a href="../../project/iot-poc-shadow/">Thing Shadows with AWS IoT</a></li>
      
    </ul>
  </div>
  





    <div class="project-related-pages content-widget-hr">
      
      

      
      
      

      
      
      

      
      
      
    </div>
  </div>
</article>
  </div>

  <div class="page-footer">
    
    
    <div class="container">
      <footer class="site-footer">

  

  

  
  <p class="powered-by">
     2021 Anders E. Nielsen
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      
      
      Published with <a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a>, <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a>, and <a href="https://github.com/rstudio/blogdown" target="_blank" rel="noopener">R Blogdown</a>.
    
  </p>
</footer>

    </div>
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/python.min.js"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/latex.min.js"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="../../js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="../../en/js/wowchemy.min.cf8ca859a9b74f8b1cd804621b13e5f1.js"></script>

    
  <script async defer src="https://buttons.github.io/buttons.js"></script>




</body>
</html>
